import os
import logging
from pyramid.authentication import AuthTktAuthenticationPolicy
from pyramid.authorization import ACLAuthorizationPolicy
from pyramid.config import Configurator
from pyramid.response import Response
from pyramid.view import view_config
from pyramid.security import remember, forget, Authenticated
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy.exc import SQLAlchemyError
from passlib.hash import bcrypt

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True)
    password = Column(String(100))

engine = create_engine('sqlite:///users.db')
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)

def get_user(username):
    session = Session()
    try:
        user = session.query(User).filter_by(username=username).first()
        return user
    except SQLAlchemyError as e:
        logger.error(f"Database error: {str(e)}")
        return None
    finally:
        session.close()

def create_user(username, password):
    session = Session()
    try:
        hashed_password = bcrypt.hash(password)
        new_user = User(username=username, password=hashed_password)
        session.add(new_user)
        session.commit()
        return new_user
    except SQLAlchemyError as e:
        logger.error(f"Database error: {str(e)}")
        session.rollback()
        return None
    finally:
        session.close()

@view_config(route_name='home', renderer='string')
def home(request):
    return "Welcome to the home page!"

@view_config(route_name='login', renderer='string')
def login(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = get_user(username)
        if user and bcrypt.verify(password, user.password):
            headers = remember(request, user.id)
            return Response("Login successful!", headers=headers)
        return Response("Login failed!")
    return "Please login"

@view_config(route_name='logout')
def logout(request):
    headers = forget(request)
    return Response("Logged out!", headers=headers)

@view_config(route_name='protected', renderer='string', permission='view')
def protected(request):
    return "This is a protected page!"

@view_config(route_name='register', renderer='string')
def register(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        if not username or not password:
            return Response("Username and password are required!")
        if create_user(username, password):
            return Response("User registered successfully!")
        return Response("Registration failed!")
    return "Please register"

@view_config(route_name='user_list', renderer='string', permission='view')
def user_list(request):
    session = Session()
    try:
        users = session.query(User).all()
        return "\n".join([f"User: {user.username}" for user in users])
    except SQLAlchemyError as e:
        logger.error(f"Database error: {str(e)}")
        return "Error retrieving user list"
    finally:
        session.close()

def add_routes(config):
    config.add_route('home', '/')
    config.add_route('login', '/login')
    config.add_route('logout', '/logout')
    config.add_route('protected', '/protected')
    config.add_route('register', '/register')
    config.add_route('user_list', '/users')

def setup_pyramid_app():
    config = Configurator()
    secret = os.environ.get('AUTH_SECRET', 'default_secret')
    authn_policy = AuthTktAuthenticationPolicy(secret, samesite='None', hashalg='sha512', secure=True, httponly=True)
    config.set_authentication_policy(authn_policy)
    config.set_authorization_policy(ACLAuthorizationPolicy())
    
    config.add_static_view('static', 'static', cache_max_age=3600)
    add_routes(config)
    config.scan()
    
    def groupfinder(userid, request):
        if userid:
            return ['group:users']
    
    config.set_root_factory(lambda request: {'group:users': ['view']})
    
    app = config.make_wsgi_app()
    return app

def main():
    from waitress import serve
    app = setup_pyramid_app()
    serve(app, host='0.0.0.0', port=6543)

if __name__ == '__main__':
    main()