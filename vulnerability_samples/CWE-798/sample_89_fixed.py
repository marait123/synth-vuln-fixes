import logging
from pymongo import MongoClient
import sys
import os

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def get_mongo_client():
    username = os.environ.get('MONGO_DB_USERNAME')
    password = os.environ.get('MONGO_DB_PASSWORD')
    return MongoClient(f'mongodb://{username}:{password}@localhost:27017/mydatabase')

def aggregate_data():
    client = get_mongo_client()
    db = client['analytics']
    collection = db['sales']
    pipeline = [
        {"$match": {"status": "A"}},
        {"$group": {"_id": "$item", "total": {"$sum": "$amount"}}}
    ]
    result = collection.aggregate(pipeline)
    return list(result)

def insert_sale(item, amount, status):
    client = get_mongo_client()
    db = client['analytics']
    collection = db['sales']
    sale = {"item": item, "amount": amount, "status": status}
    result = collection.insert_one(sale)
    logging.info(f"Inserted sale with ID: {result.inserted_id}")

def update_sale(sale_id, new_amount):
    client = get_mongo_client()
    db = client['analytics']
    collection = db['sales']
    result = collection.update_one({"_id": sale_id}, {"$set": {"amount": new_amount}})
    logging.info(f"Modified {result.modified_count} document(s)")

def delete_sale(sale_id):
    client = get_mongo_client()
    db = client['analytics']
    collection = db['sales']
    result = collection.delete_one({"_id": sale_id})
    logging.info(f"Deleted {result.deleted_count} document(s)")

def display_stats():
    client = get_mongo_client()
    db = client['analytics']
    collection = db['sales']
    total_docs = collection.count_documents({})
    total_amount = sum(doc['amount'] for doc in collection.find())
    logging.info(f"Total documents: {total_docs}")
    logging.info(f"Total amount: ${total_amount:.2f}")

def main():
    while True:
        print("\n1. Aggregate Data\n2. Insert Sale\n3. Update Sale\n4. Delete Sale\n5. Display Stats\n6. Exit")
        choice = input("Enter your choice: ")
        
        if choice == '1':
            result = aggregate_data()
            print("Aggregated Data:", result)
        elif choice == '2':
            item = input("Enter item name: ")
            amount = float(input("Enter amount: "))
            status = input("Enter status: ")
            insert_sale(item, amount, status)
        elif choice == '3':
            sale_id = input("Enter sale ID: ")
            new_amount = float(input("Enter new amount: "))
            update_sale(sale_id, new_amount)
        elif choice == '4':
            sale_id = input("Enter sale ID to delete: ")
            delete_sale(sale_id)
        elif choice == '5':
            display_stats()
        elif choice == '6':
            print("Exiting...")
            sys.exit(0)
        else:
            print("Invalid choice. Please try again.")

if __name__ == "__main__":
    main()