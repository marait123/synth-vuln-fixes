from django.http import HttpResponse
from django.shortcuts import render, redirect
from django.views.decorators.http import require_http_methods
from django.contrib.auth import authenticate, login
from django.contrib.auth.decorators import login_required
from django.contrib.auth.models import User
from django.utils.html import escape

@require_http_methods(["GET", "POST"])
def user_login(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(request, username=username, password=password)
        if user is not None:
            login(request, user)
            return redirect('profile')
    return render(request, 'login.html')

@login_required
@require_http_methods(["GET"])
def profile_view(request):
    user = request.user
    custom_message = escape(request.GET.get('message', ''))
    context = {
        'username': escape(user.username),
        'email': escape(user.email),
        'custom_message': custom_message
    }
    return HttpResponse(f"""
        <h1>Welcome, {context['username']}!</h1>
        <p>Email: {context['email']}</p>
        <p>Custom Message: {context['custom_message']}</p>
    """)

@login_required
@require_http_methods(["GET", "POST"])
def update_profile(request):
    if request.method == 'POST':
        user = request.user
        user.email = request.POST.get('email', user.email)
        user.save()
        return redirect('profile')
    return render(request, 'update_profile.html')

# URL patterns (for illustration, not actual Django URL configuration)
urlpatterns = [
    ('login/', user_login),
    ('profile/', profile_view),
    ('update-profile/', update_profile),
]

# Simple template system (for illustration)
def render(request, template_name, context=None):
    if template_name == 'login.html':
        return HttpResponse("""
            <form method="post">
                <input type="text" name="username" placeholder="Username">
                <input type="password" name="password" placeholder="Password">
                <button type="submit">Login</button>
            </form>
        """)
    elif template_name == 'update_profile.html':
        return HttpResponse("""
            <form method="post">
                <input type="email" name="email" placeholder="New Email">
                <button type="submit">Update</button>
            </form>
        """)