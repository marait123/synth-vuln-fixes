from django.http import HttpResponse, HttpResponseRedirect
from django.views.decorators.http import require_http_methods
from django.core.validators import validate_email
from django.core.exceptions import ValidationError
from django.contrib.auth import authenticate, login
from django.contrib.auth.models import User
from django.contrib.auth.decorators import login_required
from django.shortcuts import get_object_or_404
from django.utils.html import escape

@require_http_methods(["POST"])
def user_registration(request):
    email = request.POST.get('email', '')
    password = request.POST.get('password', '')
    name = request.POST.get('name', '')
    age = request.POST.get('age', '')

    try:
        validate_email(email)
    except ValidationError:
        return HttpResponse("Invalid email provided.", status=400)

    if len(password) < 8:
        return HttpResponse("Password too short.", status=400)

    if not name:
        return HttpResponse("Name is required.", status=400)

    try:
        age = int(age)
        if age < 18:
            return HttpResponse("You must be 18 or older to register.", status=400)
    except ValueError:
        return HttpResponse("Invalid age provided.", status=400)

    user = User.objects.create_user(username=email, email=email, password=password)
    user.first_name = name
    user.save()

    return HttpResponse("User successfully registered.")

@require_http_methods(["POST"])
def user_login(request):
    email = request.POST.get('email', '')
    password = request.POST.get('password', '')

    user = authenticate(request, username=email, password=password)
    if user is not None:
        login(request, user)
        return HttpResponse("Login successful.")
    else:
        return HttpResponse("Invalid login credentials.", status=400)

@login_required
def profile(request):
    user = request.user
    name = escape(user.first_name)
    email = escape(user.email)
    age = escape(str(user.profile.age)) if hasattr(user, 'profile') else "Not provided"

    profile_html = f"""
    <h1>User Profile</h1>
    <p>Name: {name}</p>
    <p>Email: {email}</p>
    <p>Age: {age}</p>
    """

    return HttpResponse(profile_html)