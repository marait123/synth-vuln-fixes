from sanic import Sanic, response
import sqlite3
import asyncio
import hashlib

app = Sanic("UserApp")

def init_db():
    conn = sqlite3.connect(':memory:')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE users
                      (id INTEGER PRIMARY KEY AUTOINCREMENT,
                       username TEXT UNIQUE NOT NULL,
                       password TEXT NOT NULL,
                       email TEXT UNIQUE NOT NULL)''')
    conn.commit()
    return conn

db_connection = init_db()

@app.route('/register', methods=['POST'])
async def register(request):
    username = request.json.get('username')
    password = request.json.get('password')
    email = request.json.get('email')
    
    if not all([username, password, email]):
        return response.json({'error': 'Missing required fields'}, status=400)
    
    hashed_password = hashlib.sha256(password.encode()).hexdigest()
    
    cursor = db_connection.cursor()
    try:
        cursor.execute("INSERT INTO users (username, password, email) VALUES (?, ?, ?)",
                       (username, hashed_password, email))
        db_connection.commit()
        return response.json({'message': 'User registered successfully'})
    except sqlite3.IntegrityError:
        return response.json({'error': 'Username or email already exists'}, status=400)

@app.route('/login', methods=['POST'])
async def login(request):
    username = request.json.get('username')
    password = request.json.get('password')
    
    if not all([username, password]):
        return response.json({'error': 'Missing required fields'}, status=400)
    
    hashed_password = hashlib.sha256(password.encode()).hexdigest()
    
    cursor = db_connection.cursor()
    cursor.execute("SELECT id FROM users WHERE username = ? AND password = ?",
                   (username, hashed_password))
    user = cursor.fetchone()
    
    if user:
        return response.json({'message': 'Login successful', 'user_id': user[0]})
    else:
        return response.json({'error': 'Invalid credentials'}, status=401)

@app.route('/get_user')
async def get_user(request):
    user_id = request.args.get('user_id', [None])[0]
    if not user_id:
        return response.json({'error': 'Missing user_id'}, status=400)
    
    cursor = db_connection.cursor()
    cursor.execute("SELECT id, username, email FROM users WHERE id = ?", (user_id,))
    user_data = cursor.fetchone()
    
    if user_data:
        return response.json({'id': user_data[0], 'username': user_data[1], 'email': user_data[2]})
    else:
        return response.json({'error': 'User not found'}, status=404)

@app.route('/update_profile', methods=['PUT'])
async def update_profile(request):
    user_id = request.json.get('user_id')
    email = request.json.get('email')
    
    if not all([user_id, email]):
        return response.json({'error': 'Missing required fields'}, status=400)
    
    cursor = db_connection.cursor()
    cursor.execute("UPDATE users SET email = ? WHERE id = ?", (email, user_id))
    db_connection.commit()
    
    if cursor.rowcount > 0:
        return response.json({'message': 'Profile updated successfully'})
    else:
        return response.json({'error': 'User not found'}, status=404)

@app.route('/list_users')
async def list_users(request):
    cursor = db_connection.cursor()
    cursor.execute("SELECT id, username, email FROM users")
    users = cursor.fetchall()
    return response.json([{'id': user[0], 'username': user[1], 'email': user[2]} for user in users])

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)