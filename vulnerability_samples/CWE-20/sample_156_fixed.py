from django.db import models
from django import forms
from django.http import JsonResponse
from django.views.decorators.http import require_POST
from django.contrib.auth.decorators import login_required
from django.shortcuts import render
from django.utils import timezone

class Feedback(models.Model):
    feedback_text = models.TextField()
    rating = models.IntegerField()
    user_email = models.EmailField()
    created_at = models.DateTimeField(auto_now_add=True)

class FeedbackForm(forms.Form):
    feedback = forms.CharField(widget=forms.Textarea)
    rating = forms.IntegerField(min_value=1, max_value=5)
    user_email = forms.EmailField()

@login_required
@require_POST
def submit_feedback(request):
    form = FeedbackForm(request.POST)
    if form.is_valid():
        feedback = Feedback(
            feedback_text=form.cleaned_data['feedback'],
            rating=form.cleaned_data['rating'],
            user_email=form.cleaned_data['user_email'],
            created_at=timezone.now()
        )
        feedback.save()
        return JsonResponse({'message': 'Feedback received'})
    else:
        return JsonResponse({'error': 'Invalid form'}, status=400)

@login_required
def list_feedback(request):
    feedbacks = Feedback.objects.all().order_by('-created_at')
    return render(request, 'feedback_list.html', {'feedbacks': feedbacks})

def feedback_stats(request):
    total_feedback = Feedback.objects.count()
    avg_rating = Feedback.objects.aggregate(models.Avg('rating'))['rating__avg']
    return JsonResponse({
        'total_feedback': total_feedback,
        'average_rating': round(avg_rating, 2) if avg_rating else 0
    })