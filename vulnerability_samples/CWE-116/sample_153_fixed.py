import sqlite3
from jinja2 import Environment, select_autoescape

class ReportGenerator:
    def __init__(self, template, db_path):
        self.template = template
        self.db_path = db_path

    def connect_to_db(self):
        return sqlite3.connect(self.db_path)

    def get_user_data(self, user_id):
        conn = self.connect_to_db()
        cursor = conn.cursor()
        cursor.execute("SELECT name, email, role FROM users WHERE id = ?", (user_id,))
        user_data = cursor.fetchone()
        conn.close()
        return user_data

    def get_report_data(self, user_id):
        user_data = self.get_user_data(user_id)
        return {
            "user": user_data[0],
            "email": user_data[1],
            "role": user_data[2],
            "summary": "User activity report",
            "data": "Some sensitive data here"
        }

    def generate_report(self, user_id):
        env = Environment(autoescape=True)  # Fixed: autoescape enabled
        template = env.from_string(self.template)
        report_data = self.get_report_data(user_id)
        return template.render(report_data)

    def save_report(self, user_id, report_content):
        conn = self.connect_to_db()
        cursor = conn.cursor()
        cursor.execute("INSERT INTO reports (user_id, content) VALUES (?, ?)", (user_id, report_content))
        conn.commit()
        conn.close()

template = """
<html>
<head>
    <title>User Report</title>
</head>
<body>
    <h1>Report for {{ user }}</h1>
    <p>Email: {{ email }}</p>
    <p>Role: {{ role }}</p>
    <p>Summary: {{ summary }}</p>
    <p>Data: {{ data }}</p>
</body>
</html>
"""

def main():
    db_path = "user_reports.db"
    report_generator = ReportGenerator(template, db_path)
    
    # Simulate user input (potentially malicious)
    user_id = 1
    
    # Generate and save report
    report_content = report_generator.generate_report(user_id)
    report_generator.save_report(user_id, report_content)
    
    print("Report generated and saved successfully.")

if __name__ == "__main__":
    main()