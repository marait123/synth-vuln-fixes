from fastapi import FastAPI, Query, HTTPException
from fastapi.responses import HTMLResponse
import subprocess
import os
import shlex

app = FastAPI()

@app.get("/", response_class=HTMLResponse)
async def root():
    return """
    <html>
        <body>
            <h1>File Search and Viewer</h1>
            <form action="/search" method="get">
                <input type="text" name="pattern" placeholder="Search pattern">
                <input type="submit" value="Search">
            </form>
            <form action="/view" method="get">
                <input type="text" name="filename" placeholder="File to view">
                <input type="submit" value="View">
            </form>
        </body>
    </html>
    """

@app.get("/search")
async def search_files(pattern: str = Query(...)):
    try:
        sanitized_pattern = shlex.quote(pattern)
        result = subprocess.run(["find", ".", "-name", f"*{sanitized_pattern}*"], capture_output=True, text=True, check=True)
        files = result.stdout.strip().split('\n')
        return {"files": files}
    except subprocess.CalledProcessError:
        raise HTTPException(status_code=400, detail="Search failed")

@app.get("/view")
async def view_file(filename: str = Query(...)):
    if not os.path.exists(filename) or not os.path.isfile(filename):
        raise HTTPException(status_code=404, detail="File not found")
    try:
        with open(filename, 'r') as file:
            content = file.read()
        return {"filename": filename, "content": content}
    except IOError:
        raise HTTPException(status_code=400, detail="Failed to read file")

@app.get("/exec")
async def exec_command(command: str = Query(...)):
    try:
        result = subprocess.run(["grep", command], capture_output=True, text=True, check=True)
        return {"output": result.stdout}
    except subprocess.CalledProcessError:
        raise HTTPException(status_code=400, detail="Command execution failed")

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)