import random
import string
from django.contrib.auth.models import User
from django.core.mail import send_mail
from django.db import models
import logging

logger = logging.getLogger(__name__)

class UserProfile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    phone_number = models.CharField(max_length=15, blank=True)
    address = models.TextField(blank=True)

def generate_temp_password(length=10):
    characters = string.ascii_letters + string.digits + string.punctuation
    return ''.join(random.choice(characters) for _ in range(length))

def send_welcome_email(email, temp_password):
    send_mail(
        'Welcome to the Platform',
        f'Your account has been created. Your temporary password is: {temp_password}',
        'from@example.com',
        [email],
        fail_silently=False,
    )

def validate_user_input(username, email):
    if not username or not email:
        return False
    if User.objects.filter(username=username).exists():
        return False
    if User.objects.filter(email=email).exists():
        return False
    return True

def log_registration_attempt(username, email, success):
    logger.info(f"Registration attempt: username={username}, email={email}, success={success}")

def register_new_user(username, email, phone_number='', address=''):
    if not validate_user_input(username, email):
        log_registration_attempt(username, email, False)
        return "Invalid input or user already exists"

    new_user = User.objects.create_user(username=username, email=email)
    new_user.set_unusable_password()  # Fixed: Set unusable password
    new_user.save()

    UserProfile.objects.create(user=new_user, phone_number=phone_number, address=address)

    temp_password = generate_temp_password()
    send_welcome_email(email, temp_password)

    log_registration_attempt(username, email, True)
    return new_user